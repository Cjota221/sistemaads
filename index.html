<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Estratégico CJOTA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .kpi-card { transition: all 0.3s ease; }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Dashboard Estratégico CJOTA</h1>
            <p class="text-gray-600 mt-2">Análise de Performance de Anúncios Meta</p>
        </header>

        <!-- Secção de Login -->
        <section id="login-section" class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-md text-center">
            <h2 class="text-2xl font-semibold mb-4">Bem-vindo(a)</h2>
            <p class="text-gray-600 mb-6">Para analisar os dados da sua conta de anúncios, por favor, conecte-se com a sua conta do Facebook.</p>
            <button onclick="window.location.href='/.netlify/functions/api/login'" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-300">
                Conectar com Facebook
            </button>
        </section>

        <!-- Secção de Análise (inicialmente oculta) -->
        <section id="analysis-section" class="hidden">

            <!-- Estado de Carregamento -->
            <div id="loading-state" class="text-center py-16">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                <p class="mt-4 text-lg font-medium text-gray-700">A carregar e analisar os seus dados...</p>
                <p class="text-gray-500">Isto pode demorar alguns segundos.</p>
            </div>
            
            <!-- Container de Erro -->
            <div id="error-container" class="hidden max-w-2xl mx-auto bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert">
                <strong class="font-bold">Ocorreu um Erro!</strong>
                <span class="block sm:inline" id="error-message">Não foi possível carregar os dados.</span>
            </div>

            <!-- Conteúdo do Dashboard (inicialmente oculto até os dados carregarem) -->
            <div id="dashboard-content" class="hidden">
                 <!-- Metas e Controles -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <label for="roas-goal" class="block text-sm font-medium text-gray-700">Meta de ROAS</label>
                        <input type="number" id="roas-goal" value="6.0" step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <label for="cpa-goal" class="block text-sm font-medium text-gray-700">Teto de CPA (R$)</label>
                        <input type="number" id="cpa-goal" value="30.00" step="0.50" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow flex items-end">
                        <button id="reanalyze-button" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300">
                            Reanalisar com Metas
                        </button>
                    </div>
                </div>

                <!-- Métricas Essenciais -->
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6 mb-8" id="kpi-grid">
                    <!-- Cards de KPI serão inseridos aqui -->
                </div>

                <!-- Painéis Estratégicos -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-bold mb-4 text-green-700">✅ A Escalar (Lucro Alto)</h3>
                        <div id="escala-content" class="space-y-4"></div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-bold mb-4 text-red-700">❌ A Otimizar (Prejuízo/Lucro Baixo)</h3>
                        <div id="otimiza-content" class="space-y-4"></div>
                    </div>
                </div>
            </div>

        </section>

    </div>

    <script>
        let rawAdData = []; // Armazena os dados brutos da API para reanálise

        // --- LÓGICA PRINCIPAL NA INICIALIZAÇÃO ---
        window.onload = function () {
            const urlParams = new URLSearchParams(window.location.search);
            const accessToken = urlParams.get('access_token');

            if (accessToken) {
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('analysis-section').classList.remove('hidden');
                document.getElementById('loading-state').classList.remove('hidden');
                
                if (window.history.replaceState) {
                    const url = new URL(window.location.href);
                    url.searchParams.delete('access_token');
                    window.history.replaceState({ path: url.href }, '', url.href);
                }

                fetchAdData(accessToken);
            } else {
                document.getElementById('login-section').classList.remove('hidden');
                document.getElementById('analysis-section').classList.add('hidden');
            }

            document.getElementById('reanalyze-button').addEventListener('click', () => {
                if (rawAdData.length > 0) {
                    processAndDisplayData(rawAdData);
                }
            });
        };

        // --- BUSCA DE DADOS DA API ---
        function fetchAdData(token) {
            fetch(`/.netlify/functions/api/data?token=${token}`)
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            let errorDetails = text;
                            try {
                                const jsonError = JSON.parse(text);
                                errorDetails = JSON.stringify(jsonError.details || jsonError, null, 2);
                            } catch (e) { /* Usa o texto bruto */ }
                            throw new Error(`O servidor respondeu com status ${response.status}. Detalhes: ${errorDetails}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.data) {
                        rawAdData = data.data; 
                        processAndDisplayData(rawAdData);
                    } else {
                        throw new Error("A resposta da API não continha o campo 'data' esperado.");
                    }
                })
                .catch(error => {
                    console.error('Erro detalhado ao buscar ou processar dados:', error);
                    document.getElementById('loading-state').classList.add('hidden');
                    document.getElementById('error-message').textContent = `Falha ao carregar os dados. Motivo: ${error.message}`;
                    document.getElementById('error-container').classList.remove('hidden');
                });
        }
        
        // --- PROCESSAMENTO E EXIBIÇÃO DOS DADOS ---
        function processAndDisplayData(data) {
            const roasGoal = parseFloat(document.getElementById('roas-goal').value);
            const cpaGoal = parseFloat(document.getElementById('cpa-goal').value);

            let totalSpend = 0;
            let totalRevenue = 0;
            let totalPurchases = 0;
            let adsets = {};

            // **CORREÇÃO AQUI** - A lógica foi adaptada para o novo formato dos dados
            data.forEach(ad => {
                // Pula o anúncio se não houver dados de insights para ele
                if (!ad.insights || !ad.insights.data || ad.insights.data.length === 0) {
                    return; 
                }
                const insights = ad.insights.data[0];

                const spend = parseFloat(insights.spend || 0);
                totalSpend += spend;

                const purchaseAction = insights.actions?.find(a => a.action_type === 'purchase');
                const purchases = parseInt(purchaseAction?.value || 0);
                totalPurchases += purchases;
                
                const revenueAction = insights.action_values?.find(a => a.action_type === 'purchase');
                const revenue = parseFloat(revenueAction?.value || 0);
                totalRevenue += revenue;

                // Usa o nome do conjunto de anúncios do objeto aninhado
                const adsetName = ad.adset.name;
                if (!adsets[adsetName]) {
                    adsets[adsetName] = { spend: 0, revenue: 0, purchases: 0 };
                }
                adsets[adsetName].spend += spend;
                adsets[adsetName].revenue += revenue;
                adsets[adsetName].purchases += purchases;
            });

            // Calcula KPIs
            const overallROAS = totalSpend > 0 ? (totalRevenue / totalSpend) : 0;
            const overallCPA = totalPurchases > 0 ? (totalSpend / totalPurchases) : 0;

            displayKPIs(totalSpend, totalRevenue, totalPurchases, overallROAS, overallCPA, roasGoal, cpaGoal);
            displayStrategicPanels(adsets, roasGoal, cpaGoal);
            
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('error-container').classList.add('hidden');
            document.getElementById('dashboard-content').classList.remove('hidden');
        }

        // --- FUNÇÕES AUXILIARES DE EXIBIÇÃO ---
        function displayKPIs(spend, revenue, purchases, roas, cpa, roasGoal, cpaGoal) {
            const kpiGrid = document.getElementById('kpi-grid');
            kpiGrid.innerHTML = ''; 

            const kpis = [
                { label: 'Investimento Total', value: `R$ ${spend.toFixed(2)}` },
                { label: 'Receita Total', value: `R$ ${revenue.toFixed(2)}` },
                { label: 'Compras', value: purchases },
                { 
                    label: 'ROAS Geral', 
                    value: roas.toFixed(2), 
                    colorClass: roas >= roasGoal ? 'text-green-600' : 'text-red-600'
                },
                { 
                    label: 'CPA Geral', 
                    value: `R$ ${cpa.toFixed(2)}`,
                    colorClass: cpa <= cpaGoal ? 'text-green-600' : 'text-red-600'
                }
            ];

            kpis.forEach(kpi => {
                const card = `
                    <div class="kpi-card bg-white p-4 rounded-lg shadow text-center">
                        <p class="text-sm text-gray-500">${kpi.label}</p>
                        <p class="text-2xl font-bold ${kpi.colorClass || ''}">${kpi.value}</p>
                    </div>
                `;
                kpiGrid.innerHTML += card;
            });
        }

        function displayStrategicPanels(adsets, roasGoal, cpaGoal) {
            const escalaContent = document.getElementById('escala-content');
            const otimizaContent = document.getElementById('otimiza-content');
            escalaContent.innerHTML = '';
            otimizaContent.innerHTML = '';

            const sortedAdsets = Object.entries(adsets).sort(([,a], [,b]) => b.spend - a.spend);

            sortedAdsets.forEach(([name, data]) => {
                const roas = data.spend > 0 ? (data.revenue / data.spend) : 0;
                const cpa = data.purchases > 0 ? (data.spend / data.purchases) : 0;

                const meetsRoas = roas >= roasGoal;
                const meetsCpa = cpa > 0 && cpa <= cpaGoal;

                const cardHtml = `
                    <div class="border p-4 rounded-lg bg-gray-50">
                        <p class="font-bold text-gray-800">${name}</p>
                        <div class="flex justify-between text-sm mt-2">
                            <span>ROAS: <span class="${roas >= roasGoal ? 'text-green-600' : 'text-red-600'} font-semibold">${roas.toFixed(2)}</span></span>
                            <span>CPA: <span class="${cpa > 0 && cpa <= cpaGoal ? 'text-green-600' : 'text-red-600'} font-semibold">R$ ${cpa.toFixed(2)}</span></span>
                            <span>Invest.: <span class="font-semibold">R$ ${data.spend.toFixed(2)}</span></span>
                        </div>
                    </div>
                `;

                if (meetsRoas && meetsCpa) {
                    escalaContent.innerHTML += cardHtml;
                } else {
                    otimizaContent.innerHTML += cardHtml;
                }
            });

            if (escalaContent.innerHTML === '') escalaContent.innerHTML = '<p class="text-gray-500">Nenhum conjunto de anúncios atingiu as metas para escalar.</p>';
            if (otimizaContent.innerHTML === '') otimizaContent.innerHTML = '<p class="text-gray-500">Todos os conjuntos de anúncios estão performando dentro das metas!</p>';
        }
    </script>
</body>
</html>

